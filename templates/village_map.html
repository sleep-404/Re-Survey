<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>{{ village.name }} - BoundaryAI</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#1e3fae",
          "background-light": "#fafafa",
          "background-dark": "#1a202d",
          "status-ok": "#10b981",
          "status-review": "#f59e0b",
          "status-conflict": "#ef4444",
        },
        fontFamily: {
          "display": ["Public Sans", "sans-serif"]
        },
      },
    },
  }
</script>
<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    #map { width: 100%; height: 100%; }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display h-screen flex flex-col overflow-hidden text-slate-900 dark:text-slate-100">
<!-- Top Navigation Bar -->
<header class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 shrink-0 z-20 shadow-sm">
<div class="flex items-center gap-6">
<a href="/" class="flex items-center gap-2 text-slate-500 hover:text-primary transition-colors">
<span class="material-symbols-outlined text-2xl">arrow_back</span>
<span class="text-sm font-medium hidden sm:block">Dashboard</span>
</a>
<div class="h-6 w-px bg-slate-300 dark:bg-slate-600 mx-2"></div>
<div>
<h1 class="text-lg font-bold leading-tight text-slate-900 dark:text-white">{{ village.name }} Village</h1>
<p class="text-xs text-slate-500 dark:text-slate-400 font-medium">{{ village.mandal }} Mandal</p>
</div>
</div>
<div class="flex items-center gap-4">
<div class="relative w-64 group">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<span class="material-symbols-outlined text-slate-400 group-focus-within:text-primary transition-colors text-[20px]">search</span>
</div>
<input id="search-input" class="block w-full pl-10 pr-3 py-2 border border-slate-200 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm" placeholder="Search Survey No..." type="text"/>
</div>
<div class="h-9 w-9 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-md">RK</div>
</div>
</header>

<div class="flex flex-1 overflow-hidden relative">
<!-- Sidebar -->
<aside class="w-[340px] bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col z-10 shrink-0 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
<div class="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-6">
<!-- Progress Card -->
<div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 border border-slate-100 dark:border-slate-600/50">
<div class="flex justify-between items-end mb-2">
<div>
<p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Status</p>
<p class="text-sm font-medium text-slate-700 dark:text-slate-200 mt-1">Digitization Progress</p>
</div>
<span class="text-2xl font-bold text-primary">{{ ((stats.approved + stats.verified) / stats.total * 100)|round|int }}%</span>
</div>
<div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2 mb-2">
<div class="bg-primary h-2 rounded-full" style="width: {{ ((stats.approved + stats.verified) / stats.total * 100)|round|int }}%"></div>
</div>
<p class="text-xs text-slate-500 dark:text-slate-400 text-right">{{ stats.approved + stats.verified }}/{{ stats.total }} Parcels Verified</p>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 gap-3">
<div class="flex items-center justify-between p-3 rounded-lg border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 hover:shadow-sm transition-shadow cursor-pointer" onclick="filterParcels('approved')">
<div class="flex items-center gap-3">
<div class="h-10 w-10 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 flex items-center justify-center text-status-ok">
<span class="material-symbols-outlined">verified</span>
</div>
<div>
<p class="text-sm font-medium text-slate-500 dark:text-slate-400">Approved</p>
<p class="text-lg font-bold text-slate-900 dark:text-white">{{ stats.approved }}</p>
</div>
</div>
<span class="material-symbols-outlined text-slate-300">chevron_right</span>
</div>

<div class="flex items-center justify-between p-3 rounded-lg border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 hover:shadow-sm transition-shadow cursor-pointer" onclick="filterParcels('review')">
<div class="flex items-center gap-3">
<div class="h-10 w-10 rounded-lg bg-amber-50 dark:bg-amber-900/20 flex items-center justify-center text-status-review">
<span class="material-symbols-outlined">fact_check</span>
</div>
<div>
<p class="text-sm font-medium text-slate-500 dark:text-slate-400">To Review</p>
<p class="text-lg font-bold text-slate-900 dark:text-white">{{ stats.review }}</p>
</div>
</div>
<span class="material-symbols-outlined text-slate-300">chevron_right</span>
</div>

<a href="/village/{{ village.id }}/review" class="flex items-center justify-between p-3 rounded-lg border border-red-100 dark:border-red-900/30 bg-red-50/30 dark:bg-red-900/10 hover:shadow-sm transition-shadow cursor-pointer group">
<div class="flex items-center gap-3">
<div class="h-10 w-10 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-status-conflict group-hover:bg-red-200 transition-colors">
<span class="material-symbols-outlined">report_problem</span>
</div>
<div>
<p class="text-sm font-medium text-red-600 dark:text-red-400">Conflicts</p>
<p class="text-lg font-bold text-slate-900 dark:text-white">{{ stats.conflict }}</p>
</div>
</div>
<div class="bg-white dark:bg-slate-700 text-xs font-bold px-2 py-1 rounded text-red-600 border border-red-200 dark:border-red-800 shadow-sm">ACTION</div>
</a>
</div>

<hr class="border-slate-100 dark:border-slate-700"/>

<!-- Map Legend -->
<div>
<h3 class="text-xs font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-base">palette</span> Legend
</h3>
<div class="space-y-2">
<div class="flex items-center gap-2">
<div class="w-4 h-4 rounded border-2 border-emerald-500 bg-emerald-500/30"></div>
<span class="text-sm text-slate-700 dark:text-slate-200">Approved</span>
</div>
<div class="flex items-center gap-2">
<div class="w-4 h-4 rounded border-2 border-blue-500 bg-blue-500/30"></div>
<span class="text-sm text-slate-700 dark:text-slate-200">Verified</span>
</div>
<div class="flex items-center gap-2">
<div class="w-4 h-4 rounded border-2 border-amber-500 bg-amber-500/30"></div>
<span class="text-sm text-slate-700 dark:text-slate-200">Needs Review</span>
</div>
<div class="flex items-center gap-2">
<div class="w-4 h-4 rounded border-2 border-red-500 bg-red-500/30"></div>
<span class="text-sm text-slate-700 dark:text-slate-200">Conflict</span>
</div>
</div>
</div>
</div>

<div class="p-5 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
<a href="/village/{{ village.id }}/review" class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-primary/30 transition-all transform active:scale-95">
<span class="material-symbols-outlined">play_arrow</span>
Start Review
</a>
</div>
</aside>

<!-- Main Map Area -->
<main class="flex-1 bg-slate-900 relative isolate overflow-hidden">
<div id="map" class="absolute inset-0 z-0"></div>

<!-- Floating Map Controls -->
<div class="absolute bottom-8 right-8 flex flex-col gap-2 z-20">
<button onclick="map.zoomIn()" class="bg-white dark:bg-slate-800 p-2 rounded-lg shadow-lg hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 transition-colors" title="Zoom In">
<span class="material-symbols-outlined block">add</span>
</button>
<button onclick="map.zoomOut()" class="bg-white dark:bg-slate-800 p-2 rounded-lg shadow-lg hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 transition-colors" title="Zoom Out">
<span class="material-symbols-outlined block">remove</span>
</button>
<div class="h-2"></div>
<button onclick="resetView()" class="bg-white dark:bg-slate-800 p-2 rounded-lg shadow-lg hover:bg-slate-50 dark:hover:bg-slate-700 text-primary transition-colors" title="Recenter Map">
<span class="material-symbols-outlined block">my_location</span>
</button>
</div>

<!-- Parcel Info Popup (shown on click) -->
<div id="parcel-popup" class="hidden absolute top-6 right-20 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 p-4 z-30 w-72">
<div class="flex justify-between items-start mb-2">
<h5 id="popup-title" class="font-bold text-slate-900 dark:text-white">Survey No. ---</h5>
<span id="popup-status" class="text-[10px] font-bold px-2 py-0.5 rounded-full uppercase">---</span>
</div>
<div class="text-xs text-slate-600 dark:text-slate-400 space-y-1 mb-3">
<p>Owner: <span id="popup-owner" class="text-slate-900 dark:text-white font-medium">---</span></p>
<p>AI Area: <span id="popup-ai-area" class="text-slate-900 dark:text-white font-medium">---</span></p>
<p>ROR Area: <span id="popup-ror-area" class="text-slate-900 dark:text-white font-medium">---</span></p>
<p>Difference: <span id="popup-diff" class="font-medium">---</span></p>
</div>
<div class="flex gap-2">
<a id="popup-review-btn" href="#" class="flex-1 bg-primary hover:bg-primary/90 text-white text-xs font-bold py-1.5 px-3 rounded text-center">Review</a>
<button onclick="closePopup()" class="bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 text-slate-700 dark:text-slate-200 text-xs font-bold py-1.5 px-3 rounded">Close</button>
</div>
</div>
</main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var map = L.map('map').setView([{{ center_lat }}, {{ center_lon }}], 15);
var parcelsLayer;
var allParcelsData;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var colors = {
    'approved': '#10b981',
    'verified': '#3b82f6',
    'review': '#f59e0b',
    'conflict': '#ef4444'
};

function getStyle(feature) {
    return {
        color: colors[feature.properties.status] || '#6b7280',
        weight: 2,
        fillOpacity: 0.4
    };
}

function onEachFeature(feature, layer) {
    layer.on('click', function(e) {
        showParcelPopup(feature.properties);
    });
}

function showParcelPopup(props) {
    document.getElementById('parcel-popup').classList.remove('hidden');
    document.getElementById('popup-title').textContent = props.ror_survey_no || props.parcel_id;
    document.getElementById('popup-owner').textContent = props.ror_owner || 'Unknown';
    document.getElementById('popup-ai-area').textContent = (props.area_acres || 0).toFixed(2) + ' ac';
    document.getElementById('popup-ror-area').textContent = (props.ror_area_acres || 0).toFixed(2) + ' ac';

    var diff = (props.area_mismatch || 0) * 100;
    var diffEl = document.getElementById('popup-diff');
    diffEl.textContent = (diff > 0 ? '+' : '') + diff.toFixed(1) + '%';
    diffEl.className = 'font-medium ' + (Math.abs(diff) > 5 ? 'text-red-600' : 'text-green-600');

    var statusEl = document.getElementById('popup-status');
    statusEl.textContent = props.status;
    statusEl.className = 'text-[10px] font-bold px-2 py-0.5 rounded-full uppercase ' +
        (props.status === 'conflict' ? 'bg-red-100 text-red-600' :
         props.status === 'review' ? 'bg-amber-100 text-amber-600' :
         props.status === 'approved' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600');

    document.getElementById('popup-review-btn').href = '/village/{{ village.id }}/parcel/' + props.parcel_id;
}

function closePopup() {
    document.getElementById('parcel-popup').classList.add('hidden');
}

function resetView() {
    map.setView([{{ center_lat }}, {{ center_lon }}], 15);
}

function filterParcels(status) {
    if (parcelsLayer) {
        map.removeLayer(parcelsLayer);
    }
    var filtered = {
        type: 'FeatureCollection',
        features: allParcelsData.features.filter(f => f.properties.status === status)
    };
    parcelsLayer = L.geoJSON(filtered, {
        style: getStyle,
        onEachFeature: onEachFeature
    }).addTo(map);
}

// Load parcels
fetch('/api/village/{{ village.id }}/parcels')
    .then(r => r.json())
    .then(data => {
        allParcelsData = data;
        parcelsLayer = L.geoJSON(data, {
            style: getStyle,
            onEachFeature: onEachFeature
        }).addTo(map);

        // Fit to parcels bounds
        if (parcelsLayer.getBounds().isValid()) {
            map.fitBounds(parcelsLayer.getBounds());
        }
    });

// Search functionality
document.getElementById('search-input').addEventListener('input', function(e) {
    var query = e.target.value.toLowerCase();
    if (!query) {
        parcelsLayer.eachLayer(l => l.setStyle({opacity: 1, fillOpacity: 0.4}));
        return;
    }
    parcelsLayer.eachLayer(function(layer) {
        var props = layer.feature.properties;
        var match = (props.ror_survey_no || '').toLowerCase().includes(query) ||
                    (props.parcel_id || '').toLowerCase().includes(query);
        layer.setStyle({opacity: match ? 1 : 0.2, fillOpacity: match ? 0.6 : 0.1});
    });
});
</script>
</body></html>
